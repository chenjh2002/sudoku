import { hs } from '@sudoku/strategy/hiddenSingleStrategy';
import { np } from '@sudoku/strategy/nakedPairsStrategy';
import { pp } from '@sudoku/strategy/pointingPairsStrategy';
import { hp } from '@sudoku/strategy/hiddenCandidatesStrategy';
import {writable} from 'svelte/store';


function CreateStrategyManager() {
  const strategiesSet = [];
  const isUsingStrategy = writable(false);
  const isGenerateSingleCandidate = writable(false);

  function determineEffectiveStrategy(grid, strategyApplyCell) {
    let hasChange = false;
    for (const { strategy, _ } of strategiesSet) {
      if (strategy.preCondition(grid)) {
        strategy.apply(grid, strategyApplyCell);
        hasChange = true;
      }
    }

    return hasChange;
  }

  return {
    addNewStrategy: (strategy, priority) => {
      strategiesSet.push({strategy: strategy, priority: priority});
      strategiesSet.sort((a, b) => a.priority - b.priority);
    },

    apply: (grid) => {
      isGenerateSingleCandidate.set(false);
      // Reset the relative position
      grid.map(row => row.map(cell => { cell.resetRelativePos(); cell.resetStrategies(); }));

      // Increase time step
      const strategyApplyCell = [];
      while (determineEffectiveStrategy(grid, strategyApplyCell)) {}

      for (let pos of strategyApplyCell) {
        if (grid[pos.y][pos.x].candidates.length === 1) {
          grid[pos.y][pos.x].explore = grid[pos.y][pos.x].candidates[0];
          isGenerateSingleCandidate.set(true);
        }
      }
      return strategyApplyCell;
    },

    getIsUsingStrategy: () => {
      return {
        subscribe: isUsingStrategy.subscribe,

        set(val) {
          isUsingStrategy.set(val);
        },

        reset() {
          isUsingStrategy.set(false);
        }
      }
    },

    getIsGenerateSingleCandidate: () => isGenerateSingleCandidate,
  }
}

export const strategyManager = CreateStrategyManager();
strategyManager.addNewStrategy(hs, hs.priority);
strategyManager.addNewStrategy(np, np.priority);
strategyManager.addNewStrategy(pp, pp.priority);
strategyManager.addNewStrategy(hp, hp.priority);